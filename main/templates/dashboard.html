{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>brighttech.rms | Dashboard</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for UI icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a cleaner look (optional) */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
        .sidebar-collapsed {
            width: 5rem !important;
            transition: width 0.3s ease-in-out;
        }

        .sidebar-expanded {
            width: 16rem !important;
            transition: width 0.3s ease-in-out;
        }

        .sidebar-collapsed .sidebar-text {
            display: none;
        }

        .sidebar-collapsed ul li a {
            justify-content: center;
        }

        .sidebar-tooltip {
            position: absolute;
            left: 5rem;
            background: #1e293b;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            opacity: 0;
            transform: translateY(-50%);
            transition: opacity 0.2s ease;
            pointer-events: none;
            white-space: nowrap;
            z-index: 50;
        }

        .sidebar-collapsed ul li a:hover .sidebar-tooltip {
            opacity: 1;
        }

        .sidebar-collapsed #toggleSidebar {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        
        .sidebar-expanded #toggleSidebar {
            position: static;
            transform: none;
        }
        
        /* Styles specific to the summary table */
        .summary-table th, .summary-table td {
            white-space: nowrap;
        }
        
        .sidebar-content-block input[type="date"],
        .sidebar-content-block select {
            color: #000; /* Ensures text is black on white background */
        }
        .elegant-script-text {
            font-family: 'Great Vibes', cursive; /* You might need to import this font */
            font-size: 30px; 
            color:rgb(123, 144, 235); 
            text-align: center;
            padding: 20px;
        }
    </style>
    <link rel="icon" type="image/png" href="{% static 'images/logo.png' %}">
</head>
<body class="bg-amber-50">

    <div class="min-h-screen ">
        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="fixed top-0 left-0 h-screen w-64 flex-shrink-0 text-gray-200 shadow-lg flex flex-col sidebar-expanded z-40" 
       style="background-color: #3D4A55;">
            <div class="h-16 flex items-center justify-between border-b border-slate-700 px-4 relative">
                <h1 class="text-xl font-bold text-white sidebar-text">Dashboard</h1>
                <button id="toggleSidebar" 
                    class="flex items-center justify-center text-white hover:text-blue-400 focus:outline-none transition-all duration-300">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>            
            <nav class="flex-grow">
                <ul class="py-4">
                
                    <!-- MODIFICATION: Only "Add Employee" is hidden for non-superusers -->
                    {% if user.is_superuser %}
                    <li class="px-4 mt-2">
                        <a href="{% url 'add_employee' %}" class="flex items-center gap-2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                            <span class="sidebar-text">Add Employee</span>
                            <span class="sidebar-tooltip">Add Employee</span>
                        </a>
                    </li>
                    {% endif %}
                    
                    <!-- "Export to Excel" is now outside the if block and visible to all users -->
                    <li class= "px-4 mt-2">
                        <a href="{% url 'export_excel' %}" class="flex items-center gap-2 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300">
                            <i data-lucide="sheet" class="w-5 h-5"></i>
                            <span class="sidebar-text">Export to Excel</span> 
                            <span class="sidebar-tooltip">Export to Excel</span>
                        </a>
                    </li> 
                </ul>

                <!-- --- SITE PIPELINE SUMMARY TABLE IN ASIDE SECTION --- -->
                <div class="p-3 mt-3 border-t border-slate-700 sidebar-content-block">
                    <h3 class="text-sm font-semibold text-white mb-2 sidebar-text"> Monthly Summary </h3>
                    
                    <!-- DATE PICKER SECTION -->
                    <div class="space-y-2 mb-4 sidebar-text">
                        <div>
                            <label for="fromDate" class="block text-xs font-medium text-slate-400">From Date</label>
                            <input type="date" id="fromDate" class="mt-1 w-full p-1.5 text-xs text-slate-900 rounded bg-white focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="toDate" class="block text-xs font-medium text-slate-400">To Date</label>
                            <input type="date" id="toDate" class="mt-1 w-full p-1.5 text-xs text-slate-900 rounded bg-white focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for='company' class="block text-xs font-medium text-slate-400">Site</label>
                            <select id="company" name="company" required class="mt-1 w-full p-1.5 text-xs text-slate-900 rounded bg-white focus:ring-blue-500 focus:border-blue-500">
                                <option value="BMM">BMM</option>
                                <option value="SLR">SLR</option>
                                <option value="ARJAS">ARJAS</option>
                                <option value="JAIRAJ">JAIRAJ</option>
                                <option value="MSSSL">MSSSL</option>
                                <option value="AGNI">AGNI</option>
                                <option value="COEGA">COEGA</option>
                                <option value="CD TECH">CD TECH</option>
                            </select>
                        </div>
                        <div>
                            <button id="filterButton" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                                Apply Filters
                            </button>
                        </div>

                    </div>
                    <!-- END DATE PICKER SECTION -->

                    <div class="bg-slate-700 rounded-lg shadow-inner overflow-hidden sidebar-text">
                        <table id="summaryMatrix" class="summary-table w-full text-xs text-white">
                            <thead class="bg-slate-600">
                                <tr>
                                    <th class="py-2 px-1 text-left font-medium">STAT</th>
                                    <th class="py-2 px-1 font-medium">SITE</th> <!-- Header will be updated by JS -->
                                </tr>
                            </thead>
                            <!-- MODIFIED: Added data-status and cursor-pointer to rows -->
                            <tbody class="divide-y divide-slate-700">
                                <tr class="hover:bg-slate-500 cursor-pointer" data-status="selected">
                                    <td class="py-2 px-1 text-left">SELECTED</td>
                                    <td class="py-2 px-1 text-center font-bold text-blue-300">0</td>
                                </tr>
                                <tr class="hover:bg-slate-500 cursor-pointer" data-status="offered">
                                    <td class="py-2 px-1 text-left">OFFERED</td>
                                    <td class="py-2 px-1 text-center font-bold text-blue-300">0</td>
                                </tr>
                                <tr class="hover:bg-slate-500 cursor-pointer" data-status="rejected">
                                    <td class="py-2 px-1 text-left">REJECTED</td>
                                    <td class="py-2 px-1 text-center font-bold text-blue-300">0</td>
                                </tr>
                                <tr class="hover:bg-slate-500 cursor-pointer" data-status="joined">
                                    <td class="py-2 px-1 text-left">JOINED</td>
                                    <td class="py-2 px-1 text-center font-bold text-blue-300">0</td>
                                </tr>
                                <tr class="hover:bg-slate-500 cursor-pointer" data-status="pending">
                                    <td class="py-2 px-1 text-left">PENDING</td>
                                    <td class="py-2 px-1 text-center font-bold text-blue-300">0</td>
                                </tr>
                                <tr class="hover:bg-slate-500 cursor-pointer" data-status="left">
                                    <td class="py-2 px-1 text-left">LEFT</td>
                                    <td class="py-2 px-1 text-center font-bold text-blue-300">0</td>
                                </tr>
                                <tr class="bg-slate-600 font-extrabold hover:bg-slate-500 cursor-pointer" data-status="total">
                                    <td class="py-2 px-1 text-left">TOTAL</td>
                                    <td class="py-2 px-1 text-center text-sm text-green-400">0</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="loadingIndicator" class="text-center mt-2 text-blue-300 text-xs hidden">
                        Filtering...
                    </div> 
                </div>
            </nav>
            <div class="p-4 border-t border-slate-700">
                <div class="flex items-center gap-3">
                    
                    <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center">
                        <img src="{% static 'images/logo.png' %}" alt="User Avatar" class="h-8 w-8">
                    </div>
            
                    <div class="sidebar-text">
                        <p class="font-semibold text-white">Administration</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="mainContent" class="ml-64 p-8 bg-gray-100 text-gray-900 transition-all duration-300 ease-in-out">

            <!-- Header -->
            <header class="flex flex-col md:flex-row justify-between items-center mb-8">
                <div class="flex items-center gap-3">
                    {% load static %}
                    <img src="{% static 'images/logo.png' %}" alt="Logo" class="h-14 w-auto">
                    
                    <div class="text-black font-bold leading-tight text-xl">
                        <span>Bright Tech Industrials</span><br>
                        <span>India Pvt Ltd</span>
                    </div>
                </div>
                
                <div class="elegant-script-text">
                        <span>Rise Above The Rest</span>
                </div>
                
                <div class="flex items-center gap-4 mt-4 md:mt-0">
                    
                    <a href="{% url 'logout' %}" class="flex items-center gap-2 bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </header>
            
            <!-- Status Count Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-7 gap-6 mb-8">
                <!-- Total Employees -->
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-slate-500">Total</p>
                        <p class="text-3xl font-bold text-slate-800">{{ total_employees }}</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                    </div>
                </div>
                <!-- Joined -->
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-slate-500">Joined</p>
                        <p class="text-3xl font-bold text-slate-800">{{ joined_count }}</p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-full">
                        <i data-lucide="user-check" class="w-6 h-6 text-purple-600"></i>
                    </div>
                </div>
                <!-- Offered -->
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-slate-500">Offered</p>
                        <p class="text-3xl font-bold text-slate-800">{{ offered_count }}</p>
                    </div>
                    <div class="bg-indigo-100 p-3 rounded-full">
                        <i data-lucide="award" class="w-6 h-6 text-indigo-600"></i>
                    </div>
                </div>
                 <!-- Selected -->
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-slate-500">Selected</p>
                        <p class="text-3xl font-bold text-slate-800">{{ selected_count }}</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                    </div>
                </div>
                <!-- Pending -->
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-slate-500">Pending</p>
                        <p class="text-3xl font-bold text-slate-800">{{ pending_count }}</p>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-full">
                        <i data-lucide="clock" class="w-6 h-6 text-yellow-600"></i>
                    </div>
                </div>
                <!-- Rejected -->
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-slate-500">Rejected</p>
                        <p class="text-3xl font-bold text-slate-800">{{ rejected_count }}</p>
                    </div>
                    <div class="bg-red-100 p-3 rounded-full">
                        <i data-lucide="x-circle" class="w-6 h-6 text-red-600"></i>
                    </div>
                </div>
                <!-- Left-->
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-slate-500">Left</p>
                        <p class="text-3xl font-bold text-slate-800">{{ left_count }}</p>
                    </div>
                    <div class="bg-gray-100 p-3 rounded-full">
                        <i data-lucide="log-out" class="w-6 h-6 text-gray-600"></i>
                    </div>
                </div>
            </div>

            <!-- Django Messages Framework (if any) -->
            {% if messages %}
            <div class="mb-6 space-y-2">
                {% for message in messages %}
                <div class="p-4 rounded-lg {% if message.tags == 'success' %} bg-green-100 text-green-800 {% else %} bg-red-100 text-red-800 {% endif %}" role="alert">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Employee List Table -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-semibold text-slate-800">Recruiting Database</h3>
                </div>
                <div class="overflow-x-auto overflow-y-auto h-[60vh]">
                    <table id="employeeTable" class="w-full">
                        <thead class="bg-blue-100 text-black-500 sticky top-0 ">
                            <tr>
                                <th class="text-left font-semibold p-4">REF_ID</th>
                                <th class="text-left font-semibold p-4">CREATED</th>
                                <th class="text-left font-semibold p-4 text-center">NAME</th>
                                <th class="text-left font-semibold p-4">CONTACT</th>
                                <th class="text-left font-semibold p-4">DESIGNATION</th>
                                <th class="text-left font-semibold p-4">SITE</th>
                                <th class="text-left font-semibold p-4">STATUS</th>
                                <th class="text-left font-semibold p-4">UPDATED</th>
                                <th class="text-left font-semibold p-4">RESUME</th>
                                <th class="text-left font-semibold p-4">ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <!-- Initial data is loaded by Django -->
                            <!-- MODIFICATION: Added data- attributes to the <tr> tag -->
                            {% for employee in employees %}
                            <!-- 
                              MODIFICATION 1: 
                              Added data-offer-letter-url and data-remarks to the <tr>.
                              These will be read by JavaScript when a badge is clicked.
                            -->
                            <tr class="hover:bg-slate-50 transition-colors"
                                data-created-date="{{ employee.created_at|date:'Y-m-d' }}"
                                data-site="{{ employee.company }}"
                                data-status="{{ employee.status|lower }}"
                                {% if employee.offer_letter %}data-offer-letter-url="{{ employee.offer_letter.url }}"{% endif %}
                                {% if employee.remarks %}data-remarks="{{ employee.remarks|escapejs }}"{% endif %}>
                                <td class="p-4 text-slate-600 font-mono">{{ employee.ref_id }}</td>
                                <td class="p-4 text-slate-600">{{ employee.created_at|date:"M. d, Y" }}</td>
                                <td class="p-4 flex items-center gap-3">
                                    {% comment %} <img src="https://placehold.co/40x40/E2E8F0/475569?text={{ employee.name.0 }}" alt="Avatar" class="w-10 h-10 rounded-full object-cover"> {% endcomment %}
                                    <div class="min-w-32 text-center">
                                        <p class=" font-semibold text-slate-800">{{ employee.name }}</p>
                                        <p class=" text-sm text-slate-500">Age: {{ employee.age }}</p>
                                    </div>
                                </td>
                                <td class="p-4 text-slate-600">{{ employee.contact_number }}</td>

                                <td class="p-4 text-slate-600">{{ employee.role }}</td>
                                <td class="p-4 text-slate-600">{{employee.company }}</td>
                                <td class="p-4">
                                    <!-- Status Badges -->
                                    {% if employee.status|lower == 'selected' %}
                                        <span class="inline-flex items-center gap-1.5 bg-green-100 text-green-700 text-xs font-medium px-2.5 py-1 rounded-full">
                                            <span class="w-2 h-2 bg-green-500 rounded-full"></span> Selected
                                        </span>
                                    {% elif employee.status|lower == 'joined' %}
                                        <span class="inline-flex items-center gap-1.5 bg-purple-100 text-purple-700 text-xs font-medium px-2.5 py-1 rounded-full">
                                            <span class="w-2 h-2 bg-purple-500 rounded-full"></span> Joined
                                        </span>
                                    {% elif employee.status|lower == 'offered' %}
                                        <!-- MODIFICATION 2: Added 'status-badge' class, 'cursor-pointer', and 'data-status-type' -->
                                        <span class="inline-flex items-center gap-1.5 bg-blue-100 text-blue-700 text-xs font-medium px-2.5 py-1 rounded-full cursor-pointer status-badge" data-status-type="offered">
                                            <span class="w-2 h-2 bg-blue-500 rounded-full"></span> Offered
                                        </span>
                                    {% elif employee.status|lower == 'pending' %}
                                         <span class="inline-flex items-center gap-1.5 bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-1 rounded-full">
                                            <span class="w-2 h-2 bg-yellow-500 rounded-full"></span> Pending
                                        </span>
                                    {% elif employee.status|lower == 'rejected' %}
                                         <!-- MODIFICATION 2: Added 'status-badge' class, 'cursor-pointer', and 'data-status-type' -->
                                         <span class="inline-flex items-center gap-1.5 bg-red-100 text-red-700 text-xs font-medium px-2.5 py-1 rounded-full cursor-pointer status-badge" data-status-type="rejected">
                                            <span class="w-2 h-2 bg-red-500 rounded-full"></span> Rejected
                                        </span>
                                    {% elif employee.status|lower == 'left' %}
                                         <span class="inline-flex items-center gap-1.5 bg-slate-200 text-slate-700 text-xs font-medium px-2.5 py-1 rounded-full">
                                            <span class="w-2 h-2 bg-slate-500 rounded-full"></span> Left
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="p-4 text-slate-600">{{ employee.updated_at|date:"M. d, Y" }}</td>
                                <td class="p-4">
                                     {% if employee.resume %}
                                     <a href="{{ employee.resume.url }}" target="_blank" class="text-blue-600 hover:underline">
                                        View
                                    </a>
                                    {% else %}
                                    <span class="text-slate-400">No File</span>
                                    {% endif %}
                                </td>
                                <td class="p-4">
                                    <div class="flex gap-2">
                                        <!-- MODIFICATION: All users can edit -->
                                        <a href="{% url 'edit_employee' employee.id %}" class="p-2 text-slate-500 hover:bg-slate-200 hover:text-slate-800 rounded-full transition-colors"><i data-lucide="edit-2" class="w-4 h-4"></i></a>
                                        
                                        <!-- MODIFICATION: Only superusers can delete -->
                                        {% if user.is_superuser %}
                                            <form action="{% url 'delete_employee' employee.id %}" method="post" class="inline">
                                                {% csrf_token %}
                                                <button typeid="submit" 
                                                        onclick="return confirm('Are you sure you want to delete this?');" 
                                                        class="p-2 text-slate-500 hover:bg-slate-200 hover:text-red-600 rounded-full transition-colors">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </form>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <!-- MODIFICATION: Added id="noEmployeesMessage" -->
                            <tr id="noEmployeesMessage">
                                <td colspan="10" class="text-center p-10 text-slate-500">
                                    <p>No employees found.</p>
                                    <!-- MODIFICATION: Changed text based on permissions -->
                                    {% if user.is_superuser %}
                                    <p class="mt-2 text-sm">Click "Add Employee" to get started.</p>
                                    {% else %}
                                    <p class="mt-2 text-sm">No employees match the current filter.</p>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                 <div class="p-4 border-t flex justify-end">
                    <!-- Pagination can be added here -->
                </div>
            </div>
        </main>
    </div>

    <!-- 
      MODIFICATION 3:
      Added the HTML for the modal popup. 
      It's hidden by default and will be controlled by new JS.
    -->
    <div id="detailsModal" class="fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="modalTitle" class="text-lg font-semibold text-slate-800">Details</h3>
                <button id="closeModalBtn" class="text-slate-500 hover:text-slate-800">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="modalContent" class="p-6 text-slate-600 min-h-[100px]">
                <!-- Content will be injected by JS -->
            </div>
        </div>
    </div>


    <!-- 
    ================================================================
    == REWRITTEN JAVASCRIPT BLOCK
    == This block now controls all filtering on the FRONTEND
    == by showing/hiding table rows.
    ================================C================================
    -->
    <script>
        // Initialize Lucide Icons
        lucide.createIcons();

        // 1. Get DOM References
        const filterButton = document.getElementById('filterButton');
        const fromDateInput = document.getElementById('fromDate');
        const toDateInput = document.getElementById('toDate');
        const companySelect = document.getElementById('company');
        const summaryMatrixBody = document.querySelector('#summaryMatrix tbody');
        const headerX = document.querySelector('#summaryMatrix thead tr th:nth-child(2)');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const employeeTableBody = document.querySelector('#employeeTable tbody'); 
        const noEmployeesMessageRow = document.getElementById('noEmployeesMessage');

        // --- MODIFICATION 4: Get new DOM references for the modal ---
        const detailsModal = document.getElementById('detailsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const closeModalBtn = document.getElementById('closeModalBtn');


        // Utility function to get CSRF token (still needed for delete forms)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Custom message box utility (replaces confirm())
        // Re-named to avoid conflict with window.confirm
        function showModalConfirm(message, callback) {
            // This is a placeholder. For a real replacement of confirm(),
            // you would build a custom modal here.
            // For now, we just log it and default to 'true' for the delete to work.
            console.warn("Confirmation required:", message);
            const userConfirmed = true; // Simulating user clicking "OK"
            
            // This is a basic implementation. A real one would use a custom modal.
            // We'll use the browser's confirm for now as it's complex to replace
            // without a full modal library.
            // The user's onclick="return confirm(...)" is still in place.
        }

        // Custom message box utility (replaces alert())
        function alertMessage(message) {
            console.warn("User Message:", message);
            const existingAlert = document.getElementById('temp-alert-message');
            if (existingAlert) existingAlert.remove();

            const alertDiv = document.createElement('div');
            alertDiv.id = 'temp-alert-message';
            alertDiv.className = 'fixed top-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-xl z-[100] transition-opacity duration-300 opacity-100';
            alertDiv.textContent = message;

            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.classList.remove('opacity-100');
                alertDiv.classList.add('opacity-0');
                setTimeout(() => alertDiv.remove(), 300);
            }, 5000);
        }

        // --- REWRITTEN: Unified Filtering Logic ---

        // Main filter function, handles date, site, AND optional status
        function applyFilters(statusToFilter = null) {
            const fromDate = fromDateInput.value;
            const toDate = toDateInput.value;
            const selectedSite = companySelect.value;

            if (!fromDate || !toDate || !selectedSite) {
                alertMessage('Please select both a From Date, a To Date, and a Site.');
                return;
            }

            // Only update header if it's a new site filter (not just a status click)
            if (statusToFilter === null) {
                if (headerX) headerX.textContent = selectedSite;
            }
            
            if (loadingIndicator) loadingIndicator.classList.remove('hidden');

            // 1. Initialize summary counts
            const counts = {
                selected: 0,
                offered: 0,
                rejected: 0,
                joined: 0,
                pending: 0,
                left: 0,
                total: 0
            };

            let visibleRows = 0;
            const allRows = employeeTableBody.querySelectorAll('tr');

            // 2. Loop through all table rows
            allRows.forEach(row => {
                const rowDate = row.dataset.createdDate;
                const rowSite = row.dataset.site;
                const rowStatus = row.dataset.status;

                if (!rowDate || !rowSite || !rowStatus) {
                    // This handles the "noEmployeesMessageRow" as well
                    if (row.id === 'noEmployeesMessage') {
                        row.style.display = 'none'; // Always hide message row during filtering
                    }
                    return; // Skip this row
                }

                // 3. Check for base matches (date and site)
                const siteMatch = (rowSite === selectedSite);
                const dateMatch = (rowDate >= fromDate && rowDate <= toDate);

                if (siteMatch && dateMatch) {
                    // This row is within the date/site range.
                    // ALWAYS count it for the summary table.
                    if (counts.hasOwnProperty(rowStatus)) {
                        counts[rowStatus]++;
                    }
                    counts.total++;

                    // 4. Now, check if it should be VISIBLE
                    // (statusToFilter is null or 'total') OR (rowStatus matches)
                    const statusMatch = (!statusToFilter || statusToFilter === 'total' || rowStatus === statusToFilter);

                    if (statusMatch) {
                        row.style.display = ''; // Show row
                        visibleRows++;
                    } else {
                        row.style.display = 'none'; // Hide row
                    }
                } else {
                    // 5. Hide row if it fails date/site match
                    row.style.display = 'none';
                }
            });

            // 6. Update the summary table with the new counts
            // This happens every time to reflect the date/site query
            updateSummaryTable(counts);

            // 7. Handle "No employees found" message
            if (noEmployeesMessageRow) {
                if (visibleRows === 0) {
                    noEmployeesMessageRow.style.display = ''; // Show message
                } else {
                    noEmployeesMessageRow.style.display = 'none'; // Hide message
                }
            }
            
            if (loadingIndicator) loadingIndicator.classList.add('hidden');
        }

        // --- Event Listener for the "Apply Filters" Button ---
        if (filterButton) {
            filterButton.addEventListener('click', function() {
                // Pass null to signal a base filter (date + site + all statuses)
                applyFilters(null); 
            });
        }

        // --- NEW: Event Listener for Clicks on the Summary Table ---
        if (summaryMatrixBody) {
            summaryMatrixBody.addEventListener('click', function(e) {
                // Find the 'tr' element that was clicked on
                const clickedRow = e.target.closest('tr');

                // Check if a valid row with a status was clicked
                if (clickedRow && clickedRow.dataset.status) {
                    const statusToFilter = clickedRow.dataset.status;
                    
                    // Call the main filter function, passing the specific status
                    applyFilters(statusToFilter);
                }
            });
        }

        // --- Function to Update the Summary Table DOM (Unchanged) ---
        // This function is still needed to update the sidebar summary
        function updateSummaryTable(counts) {
            const statusOrder = ['SELECTED', 'OFFERED', 'REJECTED', 'JOINED', 'PENDING', 'LEFT', 'TOTAL'];
            if (summaryMatrixBody) {
                summaryMatrixBody.querySelectorAll('tr').forEach((row, index) => {
                    const status = statusOrder[index];
                    const statusKey = status.toLowerCase();
                    const count = counts[statusKey] !== undefined ? counts[statusKey] : 0;
                    let countCell = row.querySelector('td:nth-child(2)');
                    if (countCell) {
                       countCell.textContent = count;
                    }
                });
            }
        }

        // --- Sidebar Toggle Logic (Unchanged) ---
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('toggleSidebar');
        const mainContent = document.getElementById('mainContent');
        
        if (toggleBtn && sidebar && mainContent) {
            toggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('sidebar-collapsed');
                sidebar.classList.toggle('sidebar-expanded');

                if (sidebar.classList.contains('sidebar-collapsed')) {
                    mainContent.classList.remove('ml-64');
                    mainContent.classList.add('ml-20'); // ml-20 is 5rem
                } else {
                    mainContent.classList.remove('ml-20');
                    mainContent.classList.add('ml-64'); // ml-64 is 16rem
                }
            });
        }

        // --- MODIFICATION 5: Add new functions and listeners for the modal ---
        
        /**
         * Opens the modal with the specified title and content.
         * @param {string} title - The text to show in the modal header.
         * @param {string} content - The HTML content to show in the modal body.
         */
        function openModal(title, content) {
            if (!detailsModal || !modalTitle || !modalContent) return;
            modalTitle.textContent = title;
            modalContent.innerHTML = content;
            detailsModal.classList.remove('hidden');
            // Re-run lucide.createIcons() in case we added an icon
            lucide.createIcons();
        }

        /**
         * Closes the modal.
         */
        function closeModal() {
            if (!detailsModal) return;
            detailsModal.classList.add('hidden');
        }

        // Listener to close the modal with the 'X' button
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', closeModal);
        }

        // Listener to close the modal by clicking on the background overlay
        if (detailsModal) {
            detailsModal.addEventListener('click', (e) => {
                // Check if the click was on the overlay (the modal itself)
                if (e.target.id === 'detailsModal') {
                    closeModal();
                }
            });
        }

        // Listener for clicks on the status badges within the table
        if (employeeTableBody) {
            employeeTableBody.addEventListener('click', (e) => {
                // Find the closest '.status-badge' that was clicked
                const badge = e.target.closest('.status-badge');
                
                // If the click wasn't on a badge, do nothing
                if (!badge) return; 

                // Find the parent table row to get its data
                const row = badge.closest('tr');
                if (!row) return;

                const statusType = badge.dataset.statusType;

                if (statusType === 'offered') {
                    const url = row.dataset.offerLetterUrl;
                    if (url) {
                        // Create a link for the modal content
                        const content = `<a href="${url}" target="_blank" class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-800 font-medium py-2 px-4 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">
                                        <i data-lucide="external-link" class="w-4 h-4"></i>
                                        View Uploaded Offer Letter
                                     </a>`;
                        openModal('Offer Letter', content);
                    } else {
                        // Show a message if no file exists
                        openModal('Offer Letter', '<p class="text-slate-500">No offer letter has been uploaded for this employee.</p>');
                    }

                } else if (statusType === 'rejected') {
                    const remarks = row.dataset.remarks;
                    if (remarks) {
                        // Show the remarks text
                        openModal('Rejection Remarks', `<p class="text-slate-700 whitespace-pre-wrap">${remarks}</p>`);
                    } else {
                        // Show a message if no remarks exist
                        openModal('Rejection Remarks', '<p class="text-slate-500">No remarks were provided for this rejection.</p>');
                    }
                }
            });
        }
    </script>
</body>
</html>

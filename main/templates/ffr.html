<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFR Manpower Management System</title>
    <!-- Include SheetJS for Client-Side Validation and logic -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6;
            --success: #27ae60; --danger: #e74c3c; --warning: #f39c12;
            --muted: #95a5a6;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1750px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        
        /* Site Wise Indicators */
        .site-status-panel { display: flex; gap: 12px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .site-card { 
            flex: 1; min-width: 140px; padding: 12px; border-radius: 8px; 
            background: white; border: 1px solid #ddd; text-align: center; 
            transition: all 0.3s ease;
        }
        .site-card.uploaded { border-top: 4px solid var(--success); background: #f0fff4; }
        .site-card.not-uploaded { border-top: 4px solid var(--danger); background: #fff5f5; }
        .site-card-name { font-weight: 800; font-size: 0.9rem; color: var(--primary); margin-bottom: 4px; }
        .site-card-ffr { font-size: 1.1rem; font-weight: 800; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .dot-green { background: var(--success); box-shadow: 0 0 5px var(--success); }
        .dot-red { background: var(--danger); box-shadow: 0 0 5px var(--danger); }

        .stats-banner { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; background: #eef2f3; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 6px solid var(--accent); }
        .stat-item { display: flex; flex-direction: column; }
        .stat-label { font-size: 0.75rem; color: #7f8c8d; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { font-size: 1.5rem; font-weight: 800; color: var(--primary); margin-top: 5px; }

        .controls { display: flex; gap: 25px; background: #fdfdfd; padding: 20px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 25px; align-items: flex-end; }
        .control-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-weight: 700; font-size: 0.9rem; color: #444; }
        select, input[type="date"] { padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1rem; outline: none; transition: border-color 0.2s; }
        select:focus, input:focus { border-color: var(--accent); }

        .table-container { max-height: 500px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 1500px; }
        thead th { position: sticky; top: 0; background: var(--primary); color: white; padding: 15px 10px; text-align: left; z-index: 10; font-weight: 600; font-size: 0.85rem; }
        tbody td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f1f7ff; }

        .input-cell input, .remark-cell input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; transition: background 0.2s; }
        .input-cell input { width: 60px; text-align: center; font-weight: 700; }
        .remark-cell input { width: 100%; min-width: 200px; }
        
        .scope-cell { font-weight: 800; color: var(--primary); }
        .ffr-cell { font-weight: 800; color: var(--accent); }
        .abs-pct-cell { font-weight: 800; color: var(--danger); }
        
        /* Fixed alignement to flex-end after removing the reset button */
        .action-bar { margin-top: 25px; display: flex; justify-content: flex-end; align-items: center; padding-top: 20px; border-top: 2px solid #eee; }
        .btn-group { display: flex; gap: 15px; align-items: center; }
        .btn { border: none; padding: 12px 28px; border-radius: 6px; font-weight: 700; cursor: pointer; transition: all 0.3s; font-size: 0.95rem; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
        .btn-download-all { background: var(--warning); color: white; }
        .btn-save { background: var(--success); color: white; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.2); }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }

        .badge { padding: 4px 8px; border-radius: 5px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .badge-hsk { background: #e8f4fd; color: #2980b9; }
        .badge-sk { background: #e9f7ef; color: #27ae60; }
        .badge-ssk { background: #fef5e7; color: #f39c12; }
        .badge-usk { background: #fdedec; color: #c0392b; }

        .alert { padding: 15px 20px; margin-bottom: 25px; border-radius: 8px; font-weight: 600; border: 1px solid transparent; }
        .alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
    </style>
    <link rel="icon" type="image/png" href="{% static 'images/logo.png' %}">
</head>
<body>

<div class="container">
    <header>
        <div style="display: flex; align-items: center; gap: 20px;">
            <a href="{% url 'employee_list' %}" class="btn" style="background: var(--muted); color: white; padding: 8px 15px;">&larr; Dashboard</a>
            <h1 style="margin:0; font-size: 1.6rem;">FFR Manpower Ledger</h1>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-download-all" onclick="validateAndExport()">Export to Excel</button>
        </div>
    </header>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-success">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <!-- Site Status Indicators -->
    <div class="site-status-panel" id="site-indicators">
        <!-- Site Cards injected by JS -->
    </div>

    <div class="stats-banner">
        <div class="stat-item"><span class="stat-label">Active Site</span><span class="stat-value">{{ selected_site|default:"ALL" }}</span></div>
        <div class="stat-item"><span class="stat-label">Total Site Scope</span><span class="stat-value" id="disp-scope">0</span></div>
        <div class="stat-item"><span class="stat-label">Avg. Site FFR %</span><span class="stat-value" id="disp-avg-ffr" style="color: var(--success);">0.00%</span></div>
        <div class="stat-item"><span class="stat-label">Avg. Absent %</span><span class="stat-value" id="disp-avg-abs" style="color: var(--danger);">0.00%</span></div>
    </div>

    <form method="GET" action="{% url 'FFR' %}" id="filterForm" class="controls">
        <div class="control-group">
            <label>Report Date</label>
            <input type="date" name="report_date" id="report_date" value="{{ report_date }}" onchange="this.form.submit()">
        </div>
        <div class="control-group">
            <label>Site Selection</label>
            <select name="site_selection" id="site_filter" onchange="this.form.submit()">
                
                {% if is_superuser %}
                    <option value="ALL" {% if selected_site == 'ALL' %}selected{% endif %}>All Sites (Global)</option>
                    <option value="BMM" {% if selected_site == 'BMM' %}selected{% endif %}>BMM</option>
                    <option value="JAIRAJ" {% if selected_site == 'JAIRAJ' %}selected{% endif %}>JAIRAJ</option>
                    <option value="MSSSL" {% if selected_site == 'MSSSL' %}selected{% endif %}>MSSSL</option>
                    <option value="Arjas" {% if selected_site == 'Arjas' %}selected{% endif %}>Arjas</option>
                    <option value="SLR" {% if selected_site == 'SLR' %}selected{% endif %}>SLR</option>
                    <option value="AGNI" {% if selected_site == 'AGNI' %}selected{% endif %}>AGNI</option>
                {% else %}
                    {% if selected_site != "NONE" %}
                        <option value="{{ selected_site }}" selected>{{ selected_site }}</option>
                    {% else %}
                        <option value="" disabled selected>Unauthorized</option>
                    {% endif %}
                {% endif %}
                
            </select>
        </div>
    </form>

    <form id="ffrForm" method="POST" action="{% url 'FFR' %}">
        {% csrf_token %}
        <input type="hidden" name="report_date" value="{{ report_date }}">
        <input type="hidden" name="site_selection" value="{{ selected_site }}">

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px;">SR</th>
                        <th style="width: 120px;">Site</th>
                        <th style="width: 150px;">Department</th>
                        <th>Designation</th>
                        <th style="width: 70px;">Skill</th>
                        <th style="width: 60px;">Scope</th>
                        <th style="width: 80px;">Present</th>
                        <th style="width: 80px;">Absent</th>
                        <th style="width: 85px;">Abs. %</th>
                        <th style="width: 70px;">W/O</th>
                        <th style="width: 70px;">OT</th>
                        <th style="width: 90px;">FFR %</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Dynamic Rows -->
                </tbody>
            </table>
        </div>

        <div class="action-bar">
            <!-- Reset Database Ledger button removed -->
            <div class="btn-group">
                <button type="submit" name="save_data" class="btn btn-save" {% if selected_site == "ALL" %}disabled title="Switch to a specific site to save records."{% endif %}>Save Site Record</button>
            </div>
        </div>
    </form>
</div>

<script>
    const sitesList = ["BMM", "JAIRAJ", "MSSSL", "Arjas", "SLR", "AGNI"];
    
    const masterData = [
        // BMM SITE (1-34)
        {sr:1, site:"BMM", dept:"Rolling Mill", desig:"Mill Tech", skill:"HSK", scope:12},
        {sr:2, site:"BMM", dept:"Rolling Mill", desig:"Cold Shear Operator", skill:"HSK", scope:7},
        {sr:3, site:"BMM", dept:"Rolling Mill", desig:"Mill Tech", skill:"SK", scope:9},
        {sr:4, site:"BMM", dept:"Rolling Mill", desig:"Welder Gascutter", skill:"SK", scope:4},
        {sr:5, site:"BMM", dept:"Rolling Mill", desig:"STACKER/Bundling Operator", skill:"HSK", scope:7},
        {sr:6, site:"BMM", dept:"Rolling Mill", desig:"Cooling bed to Bundling Operator", skill:"SK", scope:9},
        {sr:7, site:"BMM", dept:"Rolling Mill", desig:"EOT Crane Operator", skill:"HSK", scope:14},
        {sr:8, site:"BMM", dept:"Rolling Mill", desig:"PRAYASHA CNC OPERATOR", skill:"HSK", scope:2},
        {sr:9, site:"BMM", dept:"Rolling Mill", desig:"LATHE-1(AUTO & SPARK CNC)", skill:"HSK", scope:2},
        {sr:10, site:"BMM", dept:"Rolling Mill", desig:"LATHE-2", skill:"HSK", scope:2},
        {sr:11, site:"BMM", dept:"Rolling Mill", desig:"CNC Notching", skill:"HSK", scope:1},
        {sr:12, site:"BMM", dept:"Rolling Mill", desig:"CNC Branding", skill:"HSK", scope:2},
        {sr:13, site:"BMM", dept:"Rolling Mill", desig:"CNC Branding (Drilling / surface grinding)", skill:"SK", scope:1},
        {sr:14, site:"BMM", dept:"Rolling Mill", desig:"SHAPPER MC", skill:"SK", scope:1},
        {sr:15, site:"BMM", dept:"Rolling Mill", desig:"MILLING MC", skill:"SK", scope:1},
        {sr:16, site:"BMM", dept:"Rolling Mill", desig:"Fitter ROLL ASSY", skill:"HSK", scope:4},
        {sr:17, site:"BMM", dept:"Rolling Mill", desig:"Fitter STAND ASSY", skill:"HSK", scope:4},
        {sr:18, site:"BMM", dept:"Rolling Mill", desig:"Guide & STAND MAINT", skill:"HSK", scope:1},
        {sr:19, site:"BMM", dept:"Rolling Mill", desig:"Guide & STAND MAINT", skill:"SSK", scope:2},
        {sr:20, site:"BMM", dept:"Rolling Mill", desig:"ASS.FITTER ROLL ASSY", skill:"SSK", scope:4},
        {sr:21, site:"BMM", dept:"Rolling Mill", desig:"ASS.FITTER M/C SHOP", skill:"SSK", scope:3},
        {sr:22, site:"BMM", dept:"Rolling Mill", desig:"ASS.Fitter STAND ASSY", skill:"SSK", scope:2},
        {sr:23, site:"BMM", dept:"Rolling Mill", desig:"FITTER-MILL & HANDLING", skill:"HSK", scope:10},
        {sr:24, site:"BMM", dept:"Rolling Mill", desig:"WELDER MILL & HANDLING", skill:"HSK", scope:4},
        {sr:25, site:"BMM", dept:"Rolling Mill", desig:"FITTER Water Complex & EOT", skill:"SK", scope:5},
        {sr:26, site:"BMM", dept:"Rolling Mill", desig:"WELDER ASS.FITTER WATERCOMPLEX", skill:"SK", scope:3},
        {sr:27, site:"BMM", dept:"Rolling Mill", desig:"E&I Technician - Mill & Handling Area", skill:"HSK", scope:14},
        {sr:28, site:"BMM", dept:"Rolling Mill", desig:"E&I Technician - Water Complex & EOT", skill:"SK", scope:3},
        {sr:29, site:"BMM", dept:"Rolling Mill", desig:"QC & Despatch", skill:"SK", scope:3},
        {sr:30, site:"BMM", dept:"UTILITY", desig:"Pump Operator", skill:"SSK", scope:6},
        {sr:31, site:"BMM", dept:"UTILITY", desig:"Operator cum Maint Mechanical Technician", skill:"SK", scope:6},
        {sr:32, site:"BMM", dept:"UTILITY", desig:"Electrical Technician", skill:"SK", scope:1},
        {sr:33, site:"BMM", dept:"CNC Supply", desig:"CNC Notching", skill:"HSK", scope:10},
        {sr:34, site:"BMM", dept:"CNC Supply", desig:"CNC Branding", skill:"HSK", scope:4},

        // JAIRAJ (36-60)
        {sr:36, site:"JAIRAJ", dept:"Rolling Mill", desig:"Shift Technicians - Electrician", skill:"SK", scope:5},
        {sr:37, site:"JAIRAJ", dept:"Rolling Mill", desig:"PULPIT Operator", skill:"SK", scope:3},
        {sr:38, site:"JAIRAJ", dept:"Rolling Mill", desig:"SHIFT Technicians / Fitters", skill:"SK", scope:9},
        {sr:39, site:"JAIRAJ", dept:"Rolling Mill", desig:"Crane Operator", skill:"SK", scope:6},
        {sr:40, site:"JAIRAJ", dept:"Rolling Mill", desig:"Guide Fitter", skill:"SK", scope:3},
        {sr:41, site:"JAIRAJ", dept:"Rolling Mill", desig:"Rolling Stand Assembly Operators", skill:"SK", scope:6},
        {sr:42, site:"JAIRAJ", dept:"Rolling Mill", desig:"CNC Operator", skill:"SK", scope:1},
        {sr:43, site:"JAIRAJ", dept:"Rolling Mill", desig:"Machinist", skill:"SK", scope:2},
        {sr:44, site:"JAIRAJ", dept:"Rolling Mill", desig:"Welder & Gas Cutter", skill:"SK", scope:3},
        {sr:45, site:"JAIRAJ", dept:"Rolling Mill", desig:"TAG Assistants", skill:"SSK", scope:4},
        {sr:46, site:"JAIRAJ", dept:"Rolling Mill", desig:"Bundle Tagers", skill:"SSK", scope:4},
        {sr:47, site:"JAIRAJ", dept:"Rolling Mill", desig:"Dispatch Helpers", skill:"SSK", scope:4},
        {sr:48, site:"JAIRAJ", dept:"Rolling Mill", desig:"Technical Helpers", skill:"SSK", scope:10},
        {sr:49, site:"JAIRAJ", dept:"SMS", desig:"Shift Technicians - Electrician", skill:"SK", scope:6},
        {sr:50, site:"JAIRAJ", dept:"UTILITY", desig:"DCS Helpers", skill:"SSK", scope:3},
        {sr:51, site:"JAIRAJ", dept:"UTILITY", desig:"SMS & RM - Operators", skill:"SK", scope:6},
        {sr:52, site:"JAIRAJ", dept:"UTILITY", desig:"SMS & RM - Helpers", skill:"SSK", scope:3},
        {sr:53, site:"JAIRAJ", dept:"UTILITY", desig:"Utilities - Operators", skill:"SK", scope:8},
        {sr:54, site:"JAIRAJ", dept:"UTILITY", desig:"Utilities - Helpers", skill:"SSK", scope:3},
        {sr:55, site:"JAIRAJ", dept:"UTILITY", desig:"SMS, RM, MBF, Sinter - Welder (Crane Maint)", skill:"SK", scope:5},
        {sr:56, site:"JAIRAJ", dept:"UTILITY", desig:"Helpers - SMS, RM, MBF & Sinter", skill:"SK", scope:8},
        {sr:57, site:"JAIRAJ", dept:"UTILITY", desig:"Shift Technicians - MRSS", skill:"SK", scope:6},
        {sr:58, site:"JAIRAJ", dept:"UTILITY", desig:"Electricians - Cranes, Compressors, Pumphouse", skill:"SK", scope:2},
        {sr:59, site:"JAIRAJ", dept:"UTILITY", desig:"Technician (Pump Maintenance)", skill:"SK", scope:2},
        {sr:60, site:"JAIRAJ", dept:"UTILITY", desig:"Technician (Pump Maintenance)", skill:"SK", scope:2},

        // MSSSL (61-84)
        {sr:61, site:"MSSSL", dept:"BBU", desig:"Bar to Bar (Drawing)", skill:"HSK", scope:5},
        {sr:62, site:"MSSSL", dept:"BBU", desig:"Bar to Bar Peeling + Reeling Operator", skill:"HSK", scope:7},
        {sr:63, site:"MSSSL", dept:"BBU", desig:"Centreless Grinder Operator", skill:"HSK", scope:27},
        {sr:64, site:"MSSSL", dept:"BBU", desig:"Coil to Bar Draw Bench", skill:"HSK", scope:10},
        {sr:65, site:"MSSSL", dept:"BBU", desig:"Cutting Operator - Circular Saw", skill:"HSK", scope:11},
        {sr:66, site:"MSSSL", dept:"BBU", desig:"Straightening + Chamfering Operator", skill:"HSK", scope:4},
        {sr:67, site:"MSSSL", dept:"BBU", desig:"Straightening/Reeling Operator", skill:"HSK", scope:8},
        {sr:68, site:"MSSSL", dept:"BBU", desig:"Tool Room", skill:"HSK", scope:4},
        {sr:69, site:"MSSSL", dept:"BBU", desig:"Polishing Operator", skill:"HSK", scope:3},
        {sr:70, site:"MSSSL", dept:"BBU", desig:"Straightening + Profile Str. Operator", skill:"HSK", scope:4},
        {sr:71, site:"MSSSL", dept:"BBU", desig:"Shot Blasting + Pointing Operator", skill:"HSK", scope:13},
        {sr:72, site:"MSSSL", dept:"CFD", desig:"Coil to Coil Drawing Operator", skill:"HSK", scope:11},
        {sr:73, site:"MSSSL", dept:"CFD", desig:"Coil to Coil Drawing shifting/packing", skill:"HSK", scope:9},
        {sr:74, site:"MSSSL", dept:"CFD", desig:"RM Unloading + Pickling & Phosphating", skill:"HSK", scope:10},
        {sr:75, site:"MSSSL", dept:"CFD", desig:"Swaging / Pointing Operator", skill:"HSK", scope:7},
        {sr:76, site:"MSSSL", dept:"CFD", desig:"Compactor + Upender Operator", skill:"HSK", scope:8},
        {sr:77, site:"MSSSL", dept:"Maintenance", desig:"Electrical-Maintenance Supervisors", skill:"HSK", scope:10},
        {sr:78, site:"MSSSL", dept:"Maintenance", desig:"Mechanical-Maintenance Supervisor", skill:"HSK", scope:11},
        {sr:79, site:"MSSSL", dept:"TSD", desig:"ECT Helper Load/Unload/Salvage", skill:"SSK", scope:4},
        {sr:80, site:"MSSSL", dept:"TSD", desig:"Sample preparation / Testing", skill:"SSK", scope:6},
        {sr:81, site:"MSSSL", dept:"TSD", desig:"UST Helper Load/Unload/Salvage", skill:"SSK", scope:4},
        {sr:82, site:"MSSSL", dept:"HT", desig:"STC Furnace", skill:"HSK", scope:11},
        {sr:83, site:"MSSSL", dept:"HT", desig:"Bar hardening & Tempering Furnace", skill:"HSK", scope:1},
        {sr:84, site:"MSSSL", dept:"BBU", desig:"Helpers Assistant", skill:"USK", scope:10},

        // ARJAS (85-107)
        {sr:85, site:"Arjas", dept:"Rolling Mill", desig:"Welder cum gas cutter", skill:"SK", scope:3},
        {sr:86, site:"Arjas", dept:"Rolling Mill", desig:"Bar Aligner", skill:"SSK", scope:3},
        {sr:87, site:"Arjas", dept:"Rolling Mill", desig:"Bundling M/c Operator", skill:"SSK", scope:6},
        {sr:88, site:"Arjas", dept:"Rolling Mill", desig:"Sling Man", skill:"SSK", scope:3},
        {sr:89, site:"Arjas", dept:"Rolling Mill", desig:"Tag Printer", skill:"SSK", scope:3},
        {sr:90, site:"Arjas", dept:"INS- SUPPLY", desig:"Sling Man", skill:"SSK", scope:6},
        {sr:91, site:"Arjas", dept:"INS- SUPPLY", desig:"Helper", skill:"SSK", scope:6},
        {sr:92, site:"Arjas", dept:"INS- SUPPLY", desig:"Helper", skill:"SSK", scope:3},
        {sr:93, site:"Arjas", dept:"INS- SUPPLY", desig:"Operator", skill:"HSK", scope:6},
        {sr:94, site:"Arjas", dept:"INS- SUPPLY", desig:"Grinder", skill:"SSK", scope:12},
        {sr:95, site:"Arjas", dept:"INS- SUPPLY", desig:"Crane Operator", skill:"HSK", scope:1},
        {sr:96, site:"Arjas", dept:"INS- SUPPLY", desig:"Helper", skill:"USK", scope:3},
        {sr:97, site:"Arjas", dept:"INS- SUPPLY", desig:"Gas Cutter", skill:"SK", scope:3},
        {sr:98, site:"Arjas", dept:"INS - TONNAGE", desig:"Dimension Checker", skill:"HSK", scope:6},
        {sr:99, site:"Arjas", dept:"INS - TONNAGE", desig:"Gas Cutter", skill:"SK", scope:3},
        {sr:100, site:"Arjas", dept:"INS - TONNAGE", desig:"Grinder", skill:"SSK", scope:18},
        {sr:101, site:"Arjas", dept:"INS - TONNAGE", desig:"Helper", skill:"USK", scope:33},
        {sr:102, site:"Arjas", dept:"INS - TONNAGE", desig:"Shift GET", skill:"HSK", scope:3},
        {sr:103, site:"Arjas", dept:"Straitening", desig:"Helper", skill:"USK", scope:12},
        {sr:104, site:"Arjas", dept:"Heat Treatment", desig:"Dimension Checker", skill:"HSK", scope:1},
        {sr:105, site:"Arjas", dept:"Heat Treatment", desig:"Grinder", skill:"SSK", scope:2},
        {sr:106, site:"Arjas", dept:"Heat Treatment", desig:"Helper", skill:"USK", scope:1},
        {sr:107, site:"Arjas", dept:"Packaging", desig:"Helper", skill:"USK", scope:3},

        // SLR (108-115)
        {sr:108, site:"SLR", dept:"Rolling Mill", desig:"Mill Fitter", skill:"HSK", scope:9},
        {sr:109, site:"SLR", dept:"Rolling Mill", desig:"Roill Shop Fitter", skill:"HSK", scope:6},
        {sr:110, site:"SLR", dept:"Rolling Mill", desig:"Guide Fitter", skill:"HSK", scope:2},
        {sr:111, site:"SLR", dept:"Rolling Mill", desig:"Roll Shop Assistant Fitter", skill:"SK", scope:6},
        {sr:112, site:"SLR", dept:"Rolling Mill", desig:"Gas Cutter", skill:"SK", scope:3},
        {sr:113, site:"SLR", dept:"Rolling Mill", desig:"B H Operator", skill:"SSK", scope:30},
        {sr:114, site:"SLR", dept:"Rolling Mill", desig:"Mill Assistant Fitter", skill:"SSK", scope:3},
        {sr:115, site:"SLR", dept:"Rolling Mill", desig:"Office Boy", skill:"USK", scope:1},

        // AGNI (116-162)
        {sr:116, site:"AGNI", dept:"Furnace", desig:"Melter", skill:"HSK", scope:6},
        {sr:117, site:"AGNI", dept:"CCM", desig:"Shift Incharge", skill:"HSK", scope:5},
        {sr:118, site:"AGNI", dept:"CCM", desig:"Mould Operator", skill:"SK", scope:12},
        {sr:119, site:"AGNI", dept:"CCM", desig:"Gas Cutter", skill:"SK", scope:13},
        {sr:120, site:"AGNI", dept:"CCM", desig:"SBO + Fitter", skill:"SSK", scope:5},
        {sr:121, site:"AGNI", dept:"CCM", desig:"Teemer Man", skill:"SK", scope:5},
        {sr:122, site:"AGNI", dept:"CCM", desig:"Laddle Man", skill:"SK", scope:5},
        {sr:123, site:"AGNI", dept:"LADLE AREA", desig:"Ladle Mason", skill:"SSK", scope:4},
        {sr:124, site:"AGNI", dept:"TUNDISH AREA", desig:"Tundish Mason", skill:"SSK", scope:3},
        {sr:125, site:"AGNI", dept:"FORMER AREA", desig:"Forma Fitter", skill:"HSK", scope:1},
        {sr:126, site:"AGNI", dept:"FORMER AREA", desig:"Forma Welder", skill:"SK", scope:2},
        {sr:127, site:"AGNI", dept:"FORMER AREA", desig:"Forma Helper", skill:"USK", scope:2},
        {sr:128, site:"AGNI", dept:"ELECTRICAL DEPT", desig:"Sr Electrician", skill:"HSK", scope:3},
        {sr:129, site:"AGNI", dept:"ELECTRICAL DEPT", desig:"Jr Electrician", skill:"SK", scope:10},
        {sr:130, site:"AGNI", dept:"MECHANICAL DEPT", desig:"Sr Mechanical Fitter", skill:"HSK", scope:11},
        {sr:131, site:"AGNI", dept:"MECHANICAL DEPT", desig:"Jr Mechanical Fitter", skill:"SK", scope:13},
        {sr:132, site:"AGNI", dept:"LAB TECHNICIAN", desig:"Lab Chemist", skill:"HSK", scope:7},
        {sr:133, site:"AGNI", dept:"CCM- Helpers", desig:"Mould Operator - Helper", skill:"USK", scope:4},
        {sr:134, site:"AGNI", dept:"CCM- Helpers", desig:"Ladle Man - Helper", skill:"USK", scope:7},
        {sr:135, site:"AGNI", dept:"CCM- Helpers", desig:"Ladle Mason - Helper", skill:"USK", scope:2},
        {sr:136, site:"AGNI", dept:"CCM- Helpers", desig:"Tundish Mason - Helper", skill:"USK", scope:4},
        {sr:137, site:"AGNI", dept:"CCM- Helpers", desig:"Billet Yard - Helper", skill:"USK", scope:4},
        {sr:138, site:"AGNI", dept:"EOT CRANE", desig:"Billet Yard Crane Operator", skill:"HSK", scope:4},
        {sr:139, site:"AGNI", dept:"EOT CRANE", desig:"Shed -3 - Crane Operator", skill:"HSK", scope:4},
        {sr:140, site:"AGNI", dept:"EOT CRANE", desig:"Shed - 4, 7, 8, 9 - Crane Operator", skill:"HSK", scope:4},
        {sr:141, site:"AGNI", dept:"EOT CRANE", desig:"Shed 7, 8, 9 - Crane Operator", skill:"HSK", scope:12},
        {sr:142, site:"AGNI", dept:"IF - UNIT-II", desig:"Supervisor- Furnace", skill:"HSK", scope:2},
        {sr:143, site:"AGNI", dept:"IF - UNIT-II", desig:"First Hand", skill:"HSK", scope:2},
        {sr:144, site:"AGNI", dept:"IF - UNIT-II", desig:"Bariman", skill:"SK", scope:13},
        {sr:145, site:"AGNI", dept:"IF - UNIT-II", desig:"Helper", skill:"USK", scope:13},
        {sr:146, site:"AGNI", dept:"IF - UNIT-II", desig:"Patching Bariman", skill:"SK", scope:5},
        {sr:147, site:"AGNI", dept:"IF - UNIT-II", desig:"Patching Helper", skill:"USK", scope:4},
        {sr:148, site:"AGNI", dept:"IF - UNIT-III", desig:"Supervisor", skill:"HSK", scope:2},
        {sr:149, site:"AGNI", dept:"IF - UNIT-III", desig:"First Hand", skill:"HSK", scope:2},
        {sr:150, site:"AGNI", dept:"IF - UNIT-III", desig:"Bariman", skill:"SK", scope:12},
        {sr:151, site:"AGNI", dept:"IF - UNIT-III", desig:"Helper", skill:"USK", scope:12},
        {sr:152, site:"AGNI", dept:"IF - UNIT-III", desig:"Patching Bariman", skill:"SK", scope:4},
        {sr:153, site:"AGNI", dept:"IF - UNIT-III", desig:"Patching Helper", skill:"USK", scope:4},
        {sr:154, site:"AGNI", dept:"IF - UNIT-IV", desig:"Supervisor", skill:"HSK", scope:2},
        {sr:155, site:"AGNI", dept:"IF - UNIT-IV", desig:"First Hand", skill:"HSK", scope:2},
        {sr:156, site:"AGNI", dept:"IF - UNIT-IV", desig:"Bariman", skill:"SK", scope:13},
        {sr:157, site:"AGNI", dept:"IF - UNIT-IV", desig:"Helper", skill:"USK", scope:13},
        {sr:158, site:"AGNI", dept:"IF - UNIT-IV", desig:"Patching Bariman", skill:"SK", scope:5},
        {sr:159, site:"AGNI", dept:"IF - UNIT-IV", desig:"Patching Helper", skill:"USK", scope:4},
        {sr:160, site:"AGNI", dept:"QC", desig:"Lab Assistant - Helper", skill:"USK", scope:2},
        {sr:161, site:"AGNI", dept:"STAFF - SUPPLY", desig:"SITE INCHARGE", skill:"HSK", scope:1},
        {sr:162, site:"AGNI", dept:"STAFF - SUPPLY", desig:"ADMIN", skill:"HSK", scope:1}
    ];

    const dbEntries = [
        {% for e in entries %}
        {
            site: "{{ e.site|escapejs }}",
            dept: "{{ e.department|escapejs }}", desig: "{{ e.designation|escapejs }}",
            p: {{ e.present }}, a: {{ e.absent }}, w: {{ e.weekly_off }}, o: {{ e.overtime }},
            rem: "{{ e.remarks|default:''|escapejs }}"
        },
        {% endfor %}
    ];

    let currentProfiles = [];

    function getBadge(skill) {
        return `<span class="badge badge-${skill.toLowerCase()}">${skill}</span>`;
    }

    function initSiteIndicators() {
        const panel = document.getElementById('site-indicators');
        panel.innerHTML = '';
        
        sitesList.forEach(siteName => {
            const hasData = dbEntries.some(e => e.site === siteName);
            let siteTotalScope = 0;
            let siteTotalPresent = 0;
            
            const siteProfiles = masterData.filter(m => m.site === siteName);
            siteProfiles.forEach(sp => {
                siteTotalScope += sp.scope;
                const saved = dbEntries.find(d => d.site === sp.site && d.dept === sp.dept && d.desig === sp.desig);
                siteTotalPresent += saved ? saved.p : 0;
            });

            const siteFFR = siteTotalScope > 0 ? ((siteTotalPresent / siteTotalScope) * 100).toFixed(1) : "0.0";

            const card = document.createElement('div');
            card.className = `site-card ${hasData ? 'uploaded' : 'not-uploaded'}`;
            card.innerHTML = `
                <div class="site-card-name">
                    <span class="status-dot ${hasData ? 'dot-green' : 'dot-red'}"></span>
                    ${siteName}
                </div>
                <div class="site-card-ffr" style="color: ${hasData ? 'var(--success)' : 'var(--danger)'}">
                    ${siteFFR}%
                </div>
                <div style="font-size: 0.65rem; color: #95a5a6; font-weight:bold;">
                    ${hasData ? 'UPLOADED' : 'PENDING'}
                </div>
            `;
            panel.appendChild(card);
        });
    }

    function loadTable() {
        const site = "{{ selected_site|default:'ALL' }}";
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        
        // Show all if "ALL" is selected, otherwise filter
        currentProfiles = (site === "ALL") ? masterData : masterData.filter(d => d.site === site);

        currentProfiles.forEach((p) => {
            const db = dbEntries.find(d => 
                d.site === p.site && d.dept === p.dept && d.desig === p.desig
            );
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${p.sr}</td>
                <td style="font-weight: 700; color: #7f8c8d;">${p.site}<input type="hidden" name="site_${p.sr}" value="${p.site}"></td>
                <td>${p.dept}<input type="hidden" name="dept_${p.sr}" value="${p.dept}"></td>
                <td>${p.desig}<input type="hidden" name="desig_${p.sr}" value="${p.desig}"></td>
                <td>${getBadge(p.skill)}<input type="hidden" name="skill_${p.sr}" value="${p.skill}"></td>
                <td class="scope-cell">${p.scope}<input type="hidden" name="scope_${p.sr}" value="${p.scope}"></td>
                <td class="input-cell"><input type="number" name="p_${p.sr}" oninput="update()" value="${db ? db.p : 0}"></td>
                <td class="input-cell"><input type="number" name="a_${p.sr}" oninput="update()" value="${db ? db.a : 0}"></td>
                <td class="abs-pct-cell" id="ap_${p.sr}">0%</td>
                <td class="input-cell"><input type="number" name="w_${p.sr}" value="${db ? db.w : 0}"></td>
                <td class="input-cell"><input type="number" name="o_${p.sr}" value="${db ? db.o : 0}"></td>
                <td class="ffr-cell" id="fr_${p.sr}">0%</td>
                <td class="remark-cell"><input type="text" name="rem_${p.sr}" value="${db ? db.rem : ''}" placeholder="..."></td>
            `;
            tbody.appendChild(tr);
        });
        update();
        initSiteIndicators();
    }

    function update() {
        let ts = 0, tp = 0, ta = 0;
        currentProfiles.forEach(r => {
            const pVal = parseInt(document.querySelector(`input[name="p_${r.sr}"]`).value) || 0;
            const aVal = parseInt(document.querySelector(`input[name="a_${r.sr}"]`).value) || 0;
            
            const frVal = r.scope > 0 ? ((pVal / r.scope) * 100).toFixed(2) : "0.00";
            const apVal = r.scope > 0 ? ((aVal / r.scope) * 100).toFixed(2) : "0.00";
            
            document.getElementById(`fr_${r.sr}`).innerText = frVal + '%';
            document.getElementById(`ap_${r.sr}`).innerText = apVal + '%';
            
            ts += r.scope; tp += pVal; ta += aVal;
        });

        document.getElementById('disp-scope').innerText = ts;
        document.getElementById('disp-avg-ffr').innerText = (ts > 0 ? ((tp / ts) * 100).toFixed(2) : "0.00") + '%';
        document.getElementById('disp-avg-abs').innerText = (ts > 0 ? ((ta / ts) * 100).toFixed(2) : "0.00") + '%';
    }

    function validateAndExport() {
        let incomplete = false;
        currentProfiles.forEach(r => {
            const p = document.querySelector(`input[name="p_${r.sr}"]`).value;
            const a = document.querySelector(`input[name="a_${r.sr}"]`).value;
            if (p === "" || a === "") incomplete = true;
        });

        if (incomplete) {
            alert("ALERT: System detected incomplete attendance entries. Please ensure all 'Present' and 'Absent' fields are filed for the current view before exporting to Excel.");
            return;
        }
        
        // Pass current site and date to the export view
        const site = "{{ selected_site|default:'ALL' }}";
        const date = "{{ report_date }}";
        window.location.href = `{% url 'export_ffr_all' %}?site_selection=${site}&report_date=${date}`;
    }

    window.onload = loadTable;
</script>
</body>
</html>